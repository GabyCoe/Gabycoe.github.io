<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restaurant ‚Äî AddictOC√©liaque</title>
  <meta name="description" content="Fiche restaurant sans gluten test√©e (AddictOC√©liaque)." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f19;
      --panel: rgba(255,255,255,0.08);
      --panel2: rgba(255,255,255,0.06);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 20px 60px rgba(0,0,0,0.45);
      --radius: 18px;
      --radius2: 14px;
      --max: 1120px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,0.35), transparent 60%),
        radial-gradient(900px 500px at 85% 10%, rgba(16,185,129,0.25), transparent 55%),
        radial-gradient(1000px 800px at 30% 120%, rgba(244,63,94,0.18), transparent 60%),
        var(--bg);
      min-height: 100vh;
    }
    a{ color: inherit; text-decoration:none; }
    .wrap{ max-width: var(--max); margin: 0 auto; padding: 0 18px 60px; }

    /* Sticky top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 6px; gap: 12px;
      background: rgba(11,15,25,0.60);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .brand{ display:flex; align-items:center; gap: 10px; font-weight: 900; letter-spacing:-0.02em; }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(16,185,129,1));
      box-shadow: 0 10px 30px rgba(99,102,241,0.25);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:18px; color: rgba(255,255,255,0.95);
    }
    .nav{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; color: var(--muted); font-weight:600; font-size:14px; }
    .nav a{ padding: 8px 10px; border-radius:999px; }
    .nav a:hover{ background: rgba(255,255,255,0.06); color: var(--text); }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      align-items:start;
    }

    /* Sidebar */
    .side{ padding: 14px; }
    .sideTitle{
      display:flex; justify-content:space-between; align-items:baseline; gap:12px;
      padding: 6px 6px 10px;
    }
    .sideTitle h2{ margin:0; font-size:15px; }
    .count{ color: var(--muted); font-size:12.5px; }

    .sideSearch{
      margin: 0 6px 10px;
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .sideSearch input{
      width:100%;
      border:0; outline:none;
      background:transparent;
      color: var(--text);
      font-size:14px;
    }
    .sideSearch input::placeholder{ color: rgba(255,255,255,0.48); }

    .sideActions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 0 6px 12px;
    }
    .chip{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.85);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .chip.active{
      background: rgba(16,185,129,0.18);
      border-color: rgba(16,185,129,0.35);
      color: rgba(255,255,255,0.92);
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
      padding: 0 6px 6px;
      max-height: calc(100vh - 290px);
      overflow:auto;
    }
    .row{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }
    .row:hover{ background: rgba(255,255,255,0.07); }
    .row.active{
      outline: 2px solid rgba(16,185,129,0.30);
      background: rgba(16,185,129,0.10);
    }
    .rowName{ font-weight:900; margin:0 0 4px; letter-spacing:-0.01em; }
    .rowMeta{ margin:0; color: var(--muted); font-size:12.5px; line-height:1.35; }
    .rowRight{ display:flex; flex-direction:column; align-items:flex-end; gap: 8px; }
    .rowScore{
      font-weight:900;
      font-size:12.5px;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      height: fit-content;
      white-space:nowrap;
    }
    .rowDist{
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      padding: 6px 8px;
      border-radius: 999px;
      white-space:nowrap;
      display:none;
    }

    /* Detail */
    .detail{ overflow:hidden; }
    .heroImg{
      width:100%;
      height: 320px;
      object-fit: cover;
      display:block;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.2);
    }
    .detailTop{
      padding: 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
    }
    .title{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:-0.02em;
      line-height:1.15;
    }
    .meta{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13.5px;
      line-height:1.5;
    }
    .pillRow{ display:flex; gap: 8px; flex-wrap:wrap; margin-top: 10px; }
    .pill{
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      padding: 7px 10px;
      border-radius: 999px;
    }
    .note{
      padding: 0 16px 16px;
      margin:0;
      font-size: 15px;
      line-height:1.6;
    }
    .actions{
      padding: 0 16px 18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-weight: 800;
      font-size: 14px;
      display:inline-flex;
      gap: 10px;
      align-items:center;
      cursor:pointer;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(16,185,129,1));
      border: 0;
      box-shadow: 0 14px 40px rgba(99,102,241,0.22);
    }
    .btn:active{ transform: translateY(1px); }

    .favBtn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      display:inline-flex;
      gap: 8px;
      align-items:center;
      white-space:nowrap;
    }
    .favBtn.on{
      border-color: rgba(244,63,94,0.45);
      background: rgba(244,63,94,0.16);
    }

    .empty{
      padding: 16px;
      color: var(--muted);
      font-size: 14px;
      line-height:1.6;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .list{ max-height: 340px; }
      .heroImg{ height: 240px; }
      .actions{ gap: 12px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">C</div>
        <a id="homeLink" href="./index.html" style="font-weight:900; color:inherit">AddictOC√©liaque</a>
      </div>
      <div class="nav">
        <a href="./index.html#restaurants">Restaurants</a>
        <a href="./index.html#carte">Carte</a>
        <a href="./index.html#suggestion">Sugg√©rer</a>
      </div>
    </div>

    <div class="grid">
      <!-- Sidebar -->
      <aside class="card side">
        <div class="sideTitle">
          <h2>Restaurants</h2>
          <div class="count" id="count">‚Äî</div>
        </div>

        <div class="sideSearch" title="Recherche">
          <span style="opacity:.7;">üîé</span>
          <input id="q" placeholder="Rechercher un resto, quartier, tag‚Ä¶" />
        </div>

        <div class="sideActions">
          <div class="chip" id="favFilter">‚ù§Ô∏è Favoris</div>
          <div class="chip" id="nearMe">üìç Autour de moi</div>
        </div>

        <div class="list" id="list"></div>
      </aside>

      <!-- Detail -->
      <main class="card detail" id="detail">
        <img id="img" class="heroImg" alt="" style="display:none;">
        <div class="detailTop">
          <div>
            <h1 class="title" id="name">‚Äî</h1>
            <p class="meta" id="meta">‚Äî</p>
            <div class="pillRow" id="tags"></div>
          </div>
          <div class="rowScore" id="score">‚≠ê ‚Äî</div>
        </div>

        <p class="note" id="note">‚Äî</p>

        <div class="actions">
          <div class="btnRow">
            <a class="btn primary" id="gmaps" target="_blank" rel="noopener">üó∫Ô∏è Itin√©raire</a>
            <a class="btn" id="site" target="_blank" rel="noopener" style="display:none;">üîó Site</a>
            <button class="btn" id="share">üì§ Partager</button>
            <button class="btn" id="copy">üìé Copier lien</button>
          </div>

          <button class="favBtn" id="favBtn" title="Ajouter aux favoris">‚ù§Ô∏è <span id="favText">Favori</span></button>
        </div>

        <div class="empty" id="empty" style="display:none;">
          Resto introuvable. Retourne √† la liste et choisis un restaurant.
        </div>
      </main>
    </div>
  </div>

  <!-- Data -->
  <script src="./restaurants.js"></script>
  <script src="./utils.js"></script>

  <script>
    // -------------------------
    // Data + helpers
    // -------------------------

    // ‚úÖ Endpoint Google Apps Script (m√™me que sur index)
    const DATA_URL = "https://script.google.com/macros/s/AKfycbxxARTHtrZB7r5cAxPM3pMOR4EJ0CYn9x0KdO-qYNJVYxnuWa4iQ2SLZ6sLrObculU_/exec";

    // ‚úÖ DATA = on d√©marre avec ce que restaurants.js met dans window.RESTAURANTS,
    // puis on merge avec la Sheet
    let DATA = (window.RESTAURANTS && Array.isArray(window.RESTAURANTS)) ? window.RESTAURANTS.slice() : [];

    const qs = (k) => new URLSearchParams(window.location.search).get(k);
    const safe = (v, fb="‚Äî") => (v === undefined || v === null || v === "" ? fb : v);

    const tagLabel = (t) => {
      const dict = {
        dedicated_gf: "D√©di√© GF",
        brunch: "Brunch",
        takeout: "Takeout",
        pizza: "Pizza",
        vegan: "Vegan",
        wifi: "Wi-Fi",
        happy_hour: "Happy hour"
      };
      return dict[t] || t;
    };

    // ‚úÖ Convertit liens Drive (file/d/... ou open?id=...) en lien image direct
    function normalizeImageUrl(url){
      const u = String(url || "").trim();
      if (!u) return "";

      const m1 = u.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      if (m1 && m1[1]) return `https://drive.google.com/uc?export=view&id=${m1[1]}`;

      const m2 = u.match(/[?&]id=([^&]+)/);
      if (u.includes("drive.google.com") && m2 && m2[1]) return `https://drive.google.com/uc?export=view&id=${m2[1]}`;

      return u;
    }

    function normalizeFromSheet(row){
      // tags
      let tags = [];
      if (Array.isArray(row.tags)) tags = row.tags.map(t => String(t).trim()).filter(Boolean);
      else if (typeof row.tags === "string") tags = row.tags.split(",").map(t => t.trim()).filter(Boolean);
      else if (row.tags != null) tags = [String(row.tags).trim()].filter(Boolean);

      // image: on couvre plusieurs noms possibles
      const img = normalizeImageUrl(row.image || row.photo_url || row.photo || "");

      return {
        id: String(row.id || "").trim(),
        name: String(row.name || "").trim(),
        city: String(row.city || "").trim(),
        neighborhood: String(row.neighborhood || "").trim(),
        address: String(row.address || "").trim(),
        lat: Number(row.lat || 0),
        lon: Number(row.lon || 0),
        score: row.score ? Number(row.score) : null,
        scoreLabel: row.score ? String(row.score) : "‚Äî",
        image: img,
        note: String(row.note || "").trim(),
        tags,
        price: String(row.price || "").trim(),
        website: String(row.website || "").trim(),
        gfSafety: String(row.gfSafety || row.gf || "option")
      };
    }

    function mergeById(base, extra){
      const map = new Map();
      base.forEach(r => { if (r && r.id) map.set(r.id, r); });
      extra.forEach(r => {
        if (!r || !r.id) return;
        map.set(r.id, { ...(map.get(r.id) || {}), ...r });
      });
      return [...map.values()];
    }

    async function loadFromSheet(){
      try{
        const res = await fetch(`${DATA_URL}?status=approved&_=${Date.now()}`, { cache: "no-store" });
        const json = await res.json();
        if (!Array.isArray(json)) return [];
        return json.map(normalizeFromSheet).filter(r => r.id && r.name);
      } catch (e){
        console.warn("Sheet fetch failed", e);
        return [];
      }
    }

    // -------------------------
    // Favorites (localStorage)
    // -------------------------
    const FAV_KEY = "ao_favs_v1";
    const getFavs = () => {
      try { return new Set(JSON.parse(localStorage.getItem(FAV_KEY) || "[]")); }
      catch { return new Set(); }
    };
    const setFavs = (set) => {
      localStorage.setItem(FAV_KEY, JSON.stringify([...set]));
    };
    const isFav = (id) => getFavs().has(id);
    const toggleFav = (id) => {
      const favs = getFavs();
      if (favs.has(id)) favs.delete(id); else favs.add(id);
      setFavs(favs);
      return favs;
    };

    // -------------------------
    // Distance (Haversine)
    // -------------------------
    const toRad = (d) => d * Math.PI / 180;
    const distKm = (aLat,aLon,bLat,bLon) => {
      const R = 6371;
      const dLat = toRad(bLat-aLat);
      const dLon = toRad(bLon-aLon);
      const s1 = Math.sin(dLat/2)**2;
      const s2 = Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1+s2));
    };
    const fmtDist = (km) => km < 1 ? `${Math.round(km*1000)} m` : `${km.toFixed(1)} km`;

    let userPos = null; // {lat, lon}
    let nearMode = false;

    async function getUserPosition(){
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("no-geo"));
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
        );
      });
    }

    // -------------------------
    // DOM
    // -------------------------
    const listEl = document.getElementById("list");
    const countEl = document.getElementById("count");
    const qEl = document.getElementById("q");

    const imgEl = document.getElementById("img");
    const nameEl = document.getElementById("name");
    const metaEl = document.getElementById("meta");
    const tagsEl = document.getElementById("tags");
    const noteEl = document.getElementById("note");
    const scoreEl = document.getElementById("score");
    const gmapsEl = document.getElementById("gmaps");
    const siteEl = document.getElementById("site");
    const emptyEl = document.getElementById("empty");

    const favBtn = document.getElementById("favBtn");
    const favText = document.getElementById("favText");
    const favFilter = document.getElementById("favFilter");
    const nearMe = document.getElementById("nearMe");

    const shareBtn = document.getElementById("share");
    const copyBtn = document.getElementById("copy");
    const homeLink = document.getElementById("homeLink");

    // Bulletproof home link (GitHub Pages)
    homeLink.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.assign("./index.html");
    });

    let favOnly = false;

    function currentId(){
      return qs("id") || (DATA[0] && DATA[0].id) || "";
    }

    function buildList(activeId, query=""){
      const q = query.trim().toLowerCase();
      let list = DATA.slice();

      // filter: favorites
      if (favOnly){
        const favs = getFavs();
        list = list.filter(r => favs.has(r.id));
      }

      // search
      if (q){
        list = list.filter(r => {
          const hay = [r.name,r.city,r.neighborhood,r.address,r.note,...(r.tags||[])].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      // distance sort if near mode
      if (nearMode && userPos){
        list = list
          .map(r => ({
            ...r,
            _km: (typeof r.lat==="number" && typeof r.lon==="number") ? distKm(userPos.lat,userPos.lon,r.lat,r.lon) : null
          }))
          .sort((a,b) => {
            if (a._km === null && b._km === null) return 0;
            if (a._km === null) return 1;
            if (b._km === null) return -1;
            return a._km - b._km;
          });
      }

      countEl.textContent = list.length + (list.length > 1 ? " restos" : " resto");
      listEl.innerHTML = "";

      list.forEach(r => {
        const row = document.createElement("div");
        row.className = "row" + (r.id === activeId ? " active" : "");
        row.tabIndex = 0;

        const left = document.createElement("div");
        const n = document.createElement("p");
        n.className = "rowName";
        n.textContent = safe(r.name);

        const m = document.createElement("p");
        m.className = "rowMeta";
        m.textContent = `${safe(r.city)} ‚Ä¢ ${safe(r.neighborhood, "‚Äî")}`;

        left.appendChild(n);
        left.appendChild(m);

        const right = document.createElement("div");
        right.className = "rowRight";

        const sc = document.createElement("div");
        sc.className = "rowScore";
        sc.textContent = `‚≠ê ${safe(r.scoreLabel ?? r.score, "‚Äî")}`;

        const d = document.createElement("div");
        d.className = "rowDist";
        if (nearMode && userPos && typeof r.lat==="number" && typeof r.lon==="number"){
          const km = distKm(userPos.lat,userPos.lon,r.lat,r.lon);
          d.textContent = fmtDist(km);
          d.style.display = "inline-flex";
        }

        right.appendChild(sc);
        right.appendChild(d);

        row.appendChild(left);
        row.appendChild(right);

        const go = () => {
          window.location.href = `restaurant.html?id=${encodeURIComponent(r.id)}`;
        };
        row.addEventListener("click", go);
        row.addEventListener("keydown", (e) => { if (e.key === "Enter") go(); });

        listEl.appendChild(row);
      });

      return list;
    }

    function updateFavUI(id){
      const on = isFav(id);
      favBtn.classList.toggle("on", on);
      favText.textContent = on ? "Retirer" : "Ajouter";
    }

    function showDetail(id){
      const r = DATA.find(x => x.id === id);

      if (!r){
        emptyEl.style.display = "block";
        imgEl.style.display = "none";
        nameEl.textContent = "Restaurant introuvable";
        metaEl.textContent = "‚Äî";
        noteEl.textContent = "‚Äî";
        scoreEl.textContent = "‚≠ê ‚Äî";
        tagsEl.innerHTML = "";
        gmapsEl.href = "./index.html";
        siteEl.style.display = "none";
        updateFavUI(id);
        return;
      }

      emptyEl.style.display = "none";
      document.title = `${r.name} ‚Äî AddictOC√©liaque`;

      nameEl.textContent = safe(r.name);
      scoreEl.textContent = `‚≠ê ${safe(r.scoreLabel ?? r.score, "‚Äî")}`;

      // meta + distance
      let extraDist = "";
      if (nearMode && userPos && typeof r.lat==="number" && typeof r.lon==="number"){
        const km = distKm(userPos.lat,userPos.lon,r.lat,r.lon);
        extraDist = ` ‚Ä¢ üìç ${fmtDist(km)}`;
      }
      metaEl.textContent = `${safe(r.city)} ‚Ä¢ ${safe(r.neighborhood, "‚Äî")} ‚Ä¢ ${safe(r.price, "‚Äî")} ‚Ä¢ ${safe(r.address)}${extraDist}`;

      noteEl.textContent = safe(r.note, "");

      // Image
      const imgUrl = normalizeImageUrl(r.image || "");
      if (imgUrl){
        imgEl.style.display = "block";
        imgEl.src = imgUrl;
        imgEl.alt = r.name || "";
        imgEl.onerror = () => { imgEl.style.display = "none"; };
      } else {
        imgEl.style.display = "none";
      }

      // Tags
      tagsEl.innerHTML = "";
      (r.tags || []).forEach(t => {
        const p = document.createElement("div");
        p.className = "pill";
        p.textContent = tagLabel(t);
        tagsEl.appendChild(p);
      });

      // Google maps
      const q = encodeURIComponent(r.address || `${r.lat},${r.lon}`);
      gmapsEl.href = `https://www.google.com/maps/search/?api=1&query=${q}`;

      // Website
      if (r.website){
        siteEl.style.display = "inline-flex";
        siteEl.href = r.website;
      } else {
        siteEl.style.display = "none";
      }

      // Fav UI
      updateFavUI(r.id);

      // Share + copy
      const url = window.location.href;
      shareBtn.onclick = async () => {
        const shareData = { title: r.name || "Restaurant", text: "AddictOC√©liaque ‚Äî resto sans gluten", url };
        try{
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(url);
            shareBtn.textContent = "‚úÖ Lien copi√©";
            setTimeout(() => (shareBtn.textContent = "üì§ Partager"), 1200);
          }
        } catch {}
      };

      copyBtn.onclick = async () => {
        try{
          await navigator.clipboard.writeText(url);
          copyBtn.textContent = "‚úÖ Copi√©";
          setTimeout(() => (copyBtn.textContent = "üìé Copier lien"), 1200);
        } catch {
          window.prompt("Copie ce lien :", url);
        }
      };
    }

    // -------------------------
    // INIT
    // -------------------------
    function init(){
      const id = currentId();

      // Initial list + detail (avec fallback)
      buildList(id, "");
      showDetail(id);

      // Search
      qEl.addEventListener("input", () => {
        buildList(currentId(), qEl.value);
      });

      // Toggle favorites filter
      favFilter.addEventListener("click", () => {
        favOnly = !favOnly;
        favFilter.classList.toggle("active", favOnly);
        buildList(currentId(), qEl.value);

        if (favOnly && !isFav(currentId())){
          const favs = [...getFavs()];
          if (favs.length){
            window.location.href = `restaurant.html?id=${encodeURIComponent(favs[0])}`;
          }
        }
      });

      // Toggle near me
      nearMe.addEventListener("click", async () => {
        if (!nearMode){
          nearMe.textContent = "‚è≥ Localisation‚Ä¶";
          try{
            userPos = await getUserPosition();
            nearMode = true;
            nearMe.textContent = "üìç Autour de moi";
            nearMe.classList.add("active");
            buildList(currentId(), qEl.value);
            showDetail(currentId());
          } catch {
            nearMode = false;
            userPos = null;
            nearMe.textContent = "üìç Autour de moi";
            nearMe.classList.remove("active");
            alert("Impossible d‚Äôacc√©der √† ta localisation (autorisation refus√©e ?).");
          }
        } else {
          nearMode = false;
          userPos = null;
          nearMe.classList.remove("active");
          buildList(currentId(), qEl.value);
          showDetail(currentId());
        }
      });

      // Favorite button on detail
      favBtn.addEventListener("click", () => {
        const id = currentId();
        toggleFav(id);
        updateFavUI(id);

        if (favOnly){
          buildList(id, qEl.value);
          if (!isFav(id)){
            const favs = [...getFavs()];
            if (favs.length){
              window.location.href = `restaurant.html?id=${encodeURIComponent(favs[0])}`;
            }
          }
        }
      });

      // Keyboard navigation (‚Üë ‚Üì)
      document.addEventListener("keydown", (e) => {
        if (!["ArrowUp","ArrowDown"].includes(e.key)) return;

        const activeId = currentId();
        const q = qEl.value || "";

        let list = DATA.slice();
        if (favOnly){
          const favs = getFavs();
          list = list.filter(r => favs.has(r.id));
        }
        const qq = q.trim().toLowerCase();
        if (qq){
          list = list.filter(r => {
            const hay = [r.name,r.city,r.neighborhood,r.address,r.note,...(r.tags||[])].join(" ").toLowerCase();
            return hay.includes(qq);
          });
        }
        if (nearMode && userPos){
          list = list
            .map(r => ({
              ...r,
              _km: (typeof r.lat==="number" && typeof r.lon==="number") ? distKm(userPos.lat,userPos.lon,r.lat,r.lon) : null
            }))
            .sort((a,b) => {
              if (a._km === null && b._km === null) return 0;
              if (a._km === null) return 1;
              if (b._km === null) return -1;
              return a._km - b._km;
            });
        }

        const idx = list.findIndex(r => r.id === activeId);
        if (idx === -1 || list.length === 0) return;

        e.preventDefault();
        const next = (e.key === "ArrowDown")
          ? list[Math.min(idx+1, list.length-1)]
          : list[Math.max(idx-1, 0)];

        if (next && next.id !== activeId){
          window.location.href = `restaurant.html?id=${encodeURIComponent(next.id)}`;
        }
      });
    }

    // 1) rendu imm√©diat avec fallback
    init();

    // 2) merge + refresh quand restaurants.js a fini (si tu d√©clenches l'event)
    window.addEventListener("ao:restaurants:ready", (ev) => {
      const fromEvent = Array.isArray(ev.detail) ? ev.detail : [];
      if (fromEvent.length){
        DATA = mergeById(DATA, fromEvent);
        const id = currentId();
        buildList(id, qEl.value || "");
        showDetail(id);
      }
    });

    // 3) IMPORTANT: restaurant.html fetch aussi la Sheet (pour √™tre autonome)
    (async function bootSheet(){
      const sheet = await loadFromSheet();
      if (sheet.length){
        DATA = mergeById(DATA, sheet);
        const id = currentId();
        buildList(id, qEl.value || "");
        showDetail(id);
      }
    })();
  </script>
</body>
</html>
